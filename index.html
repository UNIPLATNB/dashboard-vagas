<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard de Vagas â€“ SEEDF</title>

<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f9;
  padding: 20px;
}
h1 {
  text-align: center;
}
.kpis, .charts {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 15px;
  margin-bottom: 25px;
}
.kpi, .chart-box {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,.1);
  text-align: center;
}
.kpi h2 {
  margin: 0;
  color: #005aa7;
}
</style>
</head>

<body>

<h1>ðŸ“Š Dashboard de Vagas â€“ Rede PÃºblica de Ensino</h1>

<div class="kpis">
  <div class="kpi"><h2 id="totalVagas">0</h2>Total de Vagas</div>
  <div class="kpi"><h2 id="totalEscolas">0</h2>Unidades Escolares</div>
  <div class="kpi"><h2 id="totalRegioes">4</h2>RegiÃµes</div>
  <div class="kpi"><h2 id="ultimaData">â€“</h2>Ãšltima AtualizaÃ§Ã£o</div>
</div>

<div class="charts">
  <div class="chart-box"><canvas id="chartRegiao"></canvas></div>
  <div class="chart-box"><canvas id="chartEtapa"></canvas></div>
</div>

<script>
google.charts.load('current', {packages:['corechart']});
google.charts.setOnLoadCallback(carregarTudo);

const SHEET_ID = "1n2be7xn-2u-zP1nOT7nKPZZ4_dPqK6k__zgyyhIqZ_w";

const REGIOES = [
  "NÃºcleo Bandeirante",
  "CandangolÃ¢ndia",
  "Riacho Fundo I",
  "Riacho Fundo II"
];

const ETAPAS = [
  "Ensino Infantil",
  "Ensino Fundamental Anos Iniciais",
  "Ensino Fundamental Anos Finais",
  "Ensino MÃ©dio",
  "EJA (NOTURNO)"
];

let dados = [];
let charts = {};

function carregarTudo() {
  let carregadas = 0;

  REGIOES.forEach(regiao => {
    const query = new google.visualization.Query(
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(regiao)}`
    );

    query.send(resp => {
      if (!resp.isError()) {
        processarAba(resp.getDataTable(), regiao);
      }
      carregadas++;
      if (carregadas === REGIOES.length) atualizarDashboard();
    });
  });
}

function processarAba(table, regiao) {
  for (let r = 0; r < table.getNumberOfRows(); r++) {
    const escola = table.getValue(r, 0);
    const data = table.getValue(r, 1);
    if (!escola) continue;

    for (let c = 2; c < table.getNumberOfColumns(); c += 2) {
      const etapa = table.getValue(0, c);
      const vagas = Number(table.getValue(r, c + 1)) || 0;

      if (ETAPAS.includes(etapa)) {
        dados.push({ regiao, escola, etapa, vagas, data });
      }
    }
  }
}

function atualizarDashboard() {
  document.getElementById("totalVagas").innerText =
    dados.reduce((s,d)=>s+d.vagas,0);

  document.getElementById("totalEscolas").innerText =
    new Set(dados.map(d=>d.escola)).size;

  document.getElementById("ultimaData").innerText =
    dados.map(d=>d.data).filter(Boolean).sort().pop() || "â€“";

  desenharGrafico("chartRegiao", agrupar("regiao"), "Vagas por RegiÃ£o");
  desenharGrafico("chartEtapa", agrupar("etapa"), "Vagas por Etapa");
}

function agrupar(campo) {
  const m = {};
  dados.forEach(d => m[d[campo]] = (m[d[campo]] || 0) + d.vagas);
  return Object.entries(m);
}

function desenharGrafico(id, dados, titulo) {
  if (charts[id]) charts[id].destroy();
  charts[id] = new Chart(document.getElementById(id), {
    type: "bar",
    data: {
      labels: dados.map(d=>d[0]),
      datasets: [{ label: titulo, data: dados.map(d=>d[1]) }]
    },
    options: { responsive: true }
  });
}
</script>

</body>
</html>
