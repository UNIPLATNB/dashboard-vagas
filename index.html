<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard de Vagas â€“ SEEDF</title>

<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f9;
  padding: 20px;
}
h1 {
  text-align: center;
}
.kpis, .charts {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 15px;
  margin-bottom: 25px;
}
.kpi, .chart-box {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,.1);
}
.kpi {
  text-align: center;
}
.kpi h2 {
  margin: 0;
  color: #005aa7;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  padding: 8px;
  border-bottom: 1px solid #ddd;
  text-align: left;
}
th {
  background: #f0f0f0;
}
</style>
</head>

<body>

<h1>ðŸ“Š Dashboard de Vagas â€“ Rede PÃºblica de Ensino</h1>

<div class="kpis">
  <div class="kpi"><h2 id="totalVagas">0</h2>Total de Vagas</div>
  <div class="kpi"><h2 id="totalEscolas">0</h2>Unidades Escolares</div>
  <div class="kpi"><h2 id="totalRegioes">4</h2>RegiÃµes</div>
  <div class="kpi"><h2 id="ultimaData">â€“</h2>Ãšltima AtualizaÃ§Ã£o</div>
</div>

<div class="charts">
  <div class="chart-box"><canvas id="chartEtapa"></canvas></div>
  <div class="chart-box"><canvas id="chartAno"></canvas></div>
</div>

<div class="chart-box">
  <h3 id="tituloTabela">Detalhamento por Ano/SÃ©rie</h3>
  <table>
    <thead>
      <tr>
        <th>Ano / SÃ©rie</th>
        <th>Vagas</th>
      </tr>
    </thead>
    <tbody id="tabelaAno"></tbody>
  </table>
</div>

<script>
google.charts.load('current', {packages:['corechart']});
google.charts.setOnLoadCallback(carregarTudo);

const SHEET_ID = "1n2be7xn-2u-zP1nOT7nKPZZ4_dPqK6k__zgyyhIqZ_w";

const REGIOES = [
  "NÃºcleo Bandeirante",
  "CandangolÃ¢ndia",
  "Riacho Fundo I",
  "Riacho Fundo II"
];

const ETAPAS = [
  { nome: "Ensino Infantil", anoCol: 3, vagasCol: 4 },
  { nome: "Ensino Fundamental Anos Iniciais", anoCol: 6, vagasCol: 7 },
  { nome: "Ensino Fundamental Anos Finais", anoCol: 9, vagasCol: 10 },
  { nome: "Ensino MÃ©dio", anoCol: 12, vagasCol: 13 }
];

let dados = [];
let charts = {};

function carregarTudo() {
  let carregadas = 0;

  REGIOES.forEach(regiao => {
    const query = new google.visualization.Query(
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(regiao)}`
    );

    query.send(resp => {
      if (!resp.isError()) processarAba(resp.getDataTable(), regiao);
      carregadas++;
      if (carregadas === REGIOES.length) atualizarDashboard();
    });
  });
}

function processarAba(table, regiao) {
  for (let r = 4; r < table.getNumberOfRows(); r++) {
    const escola = table.getValue(r, 1);
    if (!escola) continue;

    ETAPAS.forEach(e => {
      const anoSerie = table.getValue(r, e.anoCol);
      const vagas = Number(table.getValue(r, e.vagasCol)) || 0;
      const data = table.getValue(r, e.anoCol - 1);

      if (anoSerie && vagas > 0) {
        dados.push({
          regiao,
          escola,
          etapa: e.nome,
          anoSerie,
          vagas,
          data
        });
      }
    });
  }
}

function atualizarDashboard() {
  document.getElementById("totalVagas").innerText =
    dados.reduce((s,d)=>s+d.vagas,0);

  document.getElementById("totalEscolas").innerText =
    new Set(dados.map(d=>d.escola)).size;

  document.getElementById("ultimaData").innerText =
    dados.map(d=>d.data).filter(Boolean).sort().pop() || "â€“";

  desenharGraficoEtapa();
}

function desenharGraficoEtapa() {
  const agrupado = agrupar(dados, "etapa");

  if (charts.etapa) charts.etapa.destroy();

  charts.etapa = new Chart(document.getElementById("chartEtapa"), {
    type: "bar",
    data: {
      labels: Object.keys(agrupado),
      datasets: [{
        label: "Vagas por Etapa",
        data: Object.values(agrupado)
      }]
    },
    options: {
      onClick: (_, el) => {
        if (el.length) {
          const etapa = charts.etapa.data.labels[el[0].index];
          detalharEtapa(etapa);
        }
      }
    }
  });
}

function detalharEtapa(etapa) {
  const filtrado = dados.filter(d => d.etapa === etapa);
  const agrupado = agrupar(filtrado, "anoSerie");

  document.getElementById("tituloTabela").innerText =
    `Detalhamento â€“ ${etapa}`;

  atualizarTabela(agrupado);
  desenharGraficoAno(agrupado);
}

function desenharGraficoAno(agrupado) {
  if (charts.ano) charts.ano.destroy();

  charts.ano = new Chart(document.getElementById("chartAno"), {
    type: "bar",
    data: {
      labels: Object.keys(agrupado),
      datasets: [{
        label: "Vagas por Ano/SÃ©rie",
        data: Object.values(agrupado)
      }]
    }
  });
}

function atualizarTabela(agrupado) {
  const tbody = document.getElementById("tabelaAno");
  tbody.innerHTML = "";

  Object.entries(agrupado).forEach(([ano, vagas]) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${ano}</td><td>${vagas}</td>`;
    tbody.appendChild(tr);
  });
}

function agrupar(arr, campo) {
  return arr.reduce((acc, cur) => {
    acc[cur[campo]] = (acc[cur[campo]] || 0) + cur.vagas;
    return acc;
  }, {});
}
</script>

</body>
</html>
